<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; padding: 15px; margin: 0; color:#1e293b; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { margin-top: 0; font-size: 1.5rem; }
        
        .stats { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .stat-box { background: #f8fafc; padding: 15px; border-radius: 8px; flex: 1; min-width: 140px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-box h2 { margin: 5px 0 0 0; font-size: 1.8rem; color: #6366f1; }
        
        /* TABLEAU RESPONSIVE */
        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; } /* Min-width force le scroll sur mobile */
        th { text-align: left; background: #f1f5f9; padding: 12px; font-size: 0.85rem; color: #64748b; font-weight: 700; border-bottom: 1px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        
        .btn-val { background: #16a34a; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8rem; }
        .btn-rej { background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8rem; margin-left: 5px; }
        
        .badge { padding: 4px 8px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .badge-pending { background: #fef3c7; color: #d97706; }
        .badge-approved { background: #dcfce7; color: #166534; }
        .badge-rejected { background: #fee2e2; color: #b91c1c; }
    </style>
</head>
<body>
    <script>
        const token = localStorage.getItem('token');
        if(!token) location.href = '/login';
    </script>

    <div class="container">
        <h1>üõ†Ô∏è Administration</h1>
        
        <div class="stats">
            <div class="stat-box"><h3>Utilisateurs</h3><h2 id="totalUsers">...</h2></div>
            <div class="stat-box"><h3>Cr√©dits</h3><h2 id="totalCredits">...</h2></div>
        </div>

        <h3>üí∞ Transactions (Validation)</h3>
        <div class="table-wrap">
            <table>
                <thead><tr><th>Date</th><th>Email</th><th>Pack</th><th>Montant</th><th>R√©f√©rence</th><th>Action</th></tr></thead>
                <tbody id="transTable"></tbody>
            </table>
        </div>

        <h3>üë§ Liste Utilisateurs</h3>
        <div class="table-wrap">
            <table>
                <thead><tr><th>Email</th><th>Date Inscription</th><th>Cr√©dits</th><th>Vues</th></tr></thead>
                <tbody id="usersTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        async function loadData() {
            // LOAD STATS & USERS
            const resStats = await fetch('/api/admin/stats', { headers: { 'Authorization': 'Bearer ' + token } });
            const stats = await resStats.json();
            document.getElementById('totalUsers').innerText = stats.totalUsers;
            document.getElementById('totalCredits').innerText = stats.totalCredits;

            const resUsers = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + token } });
            const users = await resUsers.json();
            document.getElementById('usersTable').innerHTML = users.map(u => `<tr><td>${u.email}</td><td>${new Date(u.createdAt).toLocaleDateString()}</td><td>${u.credits}</td><td>${u.opens||0}</td></tr>`).join('');

            // LOAD TRANSACTIONS
            const resTrans = await fetch('/api/admin/transactions', { headers: { 'Authorization': 'Bearer ' + token } });
            const trans = await resTrans.json();
            document.getElementById('transTable').innerHTML = trans.map(t => {
                let actionHtml = '';
                if(t.status === 'pending') {
                    actionHtml = `<button class="btn-val" onclick="valid('${t._id}', 'approve')">Valider</button><button class="btn-rej" onclick="valid('${t._id}', 'reject')">Rejeter</button>`;
                } else {
                    actionHtml = t.status === 'approved' ? '<span class="badge badge-approved">Pay√©</span>' : '<span class="badge badge-rejected">Refus√©</span>';
                }
                return `<tr>
                    <td>${new Date(t.date).toLocaleDateString()} <small>${new Date(t.date).toLocaleTimeString()}</small></td>
                    <td>${t.userId?.email || 'Inconnu'}</td>
                    <td style="font-weight:bold;">${t.pack.toUpperCase()}</td>
                    <td>${t.amount} FCFA</td>
                    <td style="font-family:monospace; color:#6366f1;">${t.ref}</td>
                    <td>${actionHtml}</td>
                </tr>`;
            }).join('');
        }

        async function valid(id, action) {
            if(!confirm(action==='approve' ? "Confirmer r√©ception argent ?" : "Refuser ?")) return;
            await fetch('/api/admin/validate-transaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ transactionId: id, action })
            });
            loadData();
        }
        loadData();
    </script>
</body>
</html>