<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Newsletter SaaS</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #0f172a; --accent: #6366f1; --bg: #f1f5f9; --text: #1e293b; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --card-bg: #ffffff; --radius: 16px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 80px; }
        .container { max-width: 1100px; margin: 0 auto; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .refresh-btn { background: white; border: 1px solid #cbd5e1; padding: 10px; border-radius: 50%; cursor: pointer; color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition:0.2s; }
        .refresh-btn:hover { transform: rotate(180deg); color: var(--accent); border-color: var(--accent); }

        /* KPI CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .kpi-card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-left: 5px solid var(--accent); }
        .kpi-title { font-size: 0.75rem; color: #64748b; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; margin-top: 5px; color: var(--primary); }
        .kpi-icon { float: right; opacity: 0.1; font-size: 1.5rem; }

        /* TABS NAVIGATION */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { background: transparent; border: none; padding: 10px 20px; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; font-size: 1rem; transition:0.2s; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* TRANSACTIONS & TABLES */
        .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .card-list { display: flex; flex-direction: column; gap: 15px; }
        
        /* CARD DESIGN FOR ITEMS (Mobile First) */
        .item-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; transition:0.2s; }
        .item-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .item-info h4 { margin: 0 0 5px 0; font-size: 1rem; color: var(--primary); }
        .item-info p { margin: 0; font-size: 0.85rem; color: #64748b; }
        .item-meta { text-align: right; }
        .price-tag { font-weight: 800; color: var(--accent); font-size: 1.1rem; }
        
        /* ACTIONS */
        .actions { display: flex; gap: 10px; margin-top: 5px; }
        .btn-act { border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-approve { background: #dcfce7; color: #166534; }
        .btn-approve:hover { background: #16a34a; color: white; }
        .btn-reject { background: #fee2e2; color: #991b1b; }
        .btn-reject:hover { background: #dc2626; color: white; }
        .btn-delete { background: #f1f5f9; color: #64748b; }
        .btn-delete:hover { background: #ef4444; color: white; }

        /* BADGES */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-pending { background: #fef3c7; color: #d97706; }
        .badge-approved { background: #dcfce7; color: #166534; }
        .badge-rejected { background: #fee2e2; color: #991b1b; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .item-card { flex-direction: column; align-items: flex-start; gap: 15px; }
            .item-meta { text-align: left; width: 100%; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f1f5f9; padding-top: 10px; }
            .header { margin-bottom: 20px; }
        }
    </style>
</head>
<body>
    <script>
        const token = localStorage.getItem('token');
        if(!token) location.href = '/login';
    </script>

    <div class="container">
        <div class="header">
            <div class="brand"><i class="fa-solid fa-shield-halved"></i> Admin Panel</div>
            <div style="display:flex; gap:10px;">
                <button class="refresh-btn" onclick="loadData()"><i class="fa-solid fa-rotate-right"></i></button>
                <button class="refresh-btn" onclick="location.href='/'" style="color:#ef4444; border-color:#fca5a5;"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="kpi-card" style="border-color: #10b981;">
                <i class="fa-solid fa-sack-dollar kpi-icon"></i>
                <div class="kpi-title">Chiffre d'Affaires</div>
                <div class="kpi-value" id="kpiRevenue">0 F</div>
            </div>
            <div class="kpi-card" style="border-color: #6366f1;">
                <i class="fa-solid fa-users kpi-icon"></i>
                <div class="kpi-title">Utilisateurs</div>
                <div class="kpi-value" id="kpiUsers">0</div>
            </div>
            <div class="kpi-card" style="border-color: #f59e0b;">
                <i class="fa-solid fa-hourglass-half kpi-icon"></i>
                <div class="kpi-title">En Attente</div>
                <div class="kpi-value" id="kpiPending">0</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('transactions')">üí∞ Transactions</button>
            <button class="tab-btn" onclick="switchTab('users')">üë• Utilisateurs</button>
            <button class="tab-btn" onclick="switchTab('feedbacks')">üí¨ Feedbacks</button>
        </div>

        <div id="tab-transactions" class="tab-content active">
            <div class="section-title">Demandes de Rechargement</div>
            <div id="transactionsList" class="card-list">
                <div style="text-align:center; padding:20px; color:#94a3b8;">Chargement...</div>
            </div>
        </div>

        <div id="tab-users" class="tab-content">
            <div class="section-title">Gestion des Clients</div>
            <div id="usersList" class="card-list"></div>
        </div>

        <div id="tab-feedbacks" class="tab-content">
            <div class="section-title">Messages & Avis</div>
            <div id="feedbacksList" class="card-list"></div>
        </div>
    </div>

    <script>
        // --- NAVIGATION ONGLETS ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // --- CHARGEMENT DES DONN√âES ---
        async function loadData() {
            const headers = { 'Authorization': 'Bearer ' + token };
            
            // 1. STATS & USERS
            try {
                const resStats = await fetch('/api/admin/stats', { headers });
                const stats = await resStats.json();
                
                const resUsers = await fetch('/api/admin/users', { headers });
                const users = await resUsers.json();
                
                document.getElementById('kpiUsers').innerText = stats.totalUsers;
                renderUsers(users);
            } catch(e) { console.error(e); }

            // 2. TRANSACTIONS
            try {
                const resTrans = await fetch('/api/admin/transactions', { headers });
                const transactions = await resTrans.json();
                
                // Calcul du Chiffre d'Affaires (Somme des transactions approuv√©es)
                const revenue = transactions.filter(t => t.status === 'approved').reduce((acc, curr) => acc + curr.amount, 0);
                document.getElementById('kpiRevenue').innerText = revenue.toLocaleString() + ' F';
                
                // Compteur "En attente"
                const pendingCount = transactions.filter(t => t.status === 'pending').length;
                document.getElementById('kpiPending').innerText = pendingCount;
                
                renderTransactions(transactions);
            } catch(e) { console.error(e); }

            // 3. FEEDBACKS
            try {
                const resFeed = await fetch('/api/admin/feedbacks', { headers });
                const feedbacks = await resFeed.json();
                renderFeedbacks(feedbacks);
            } catch(e) {}
        }

        // --- RENDERING TRANSACTIONS ---
        function renderTransactions(list) {
            const container = document.getElementById('transactionsList');
            if(list.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px;">Aucune transaction.</div>'; return; }
            
            container.innerHTML = list.map(t => {
                const date = new Date(t.date).toLocaleDateString() + ' ' + new Date(t.date).toLocaleTimeString().slice(0,5);
                let statusBadge = '';
                let actions = '';

                if(t.status === 'pending') {
                    statusBadge = '<span class="badge badge-pending">En Attente</span>';
                    actions = `
                        <div class="actions">
                            <button class="btn-act btn-approve" onclick="processTransac('${t._id}', 'approve')"><i class="fa-solid fa-check"></i> Valider</button>
                            <button class="btn-act btn-reject" onclick="processTransac('${t._id}', 'reject')"><i class="fa-solid fa-xmark"></i> Rejeter</button>
                        </div>
                    `;
                } else if(t.status === 'approved') {
                    statusBadge = '<span class="badge badge-approved">Valid√©</span>';
                } else {
                    statusBadge = '<span class="badge badge-rejected">Rejet√©</span>';
                }

                return `
                <div class="item-card" style="${t.status === 'pending' ? 'border-left: 5px solid #f59e0b;' : ''}">
                    <div class="item-info">
                        <h4>${t.pack.toUpperCase()} <span style="font-weight:400; color:#64748b;">par</span> ${t.userId ? t.userId.email : 'Inconnu'}</h4>
                        <p><i class="fa-regular fa-clock"></i> ${date} ‚Ä¢ Ref: <b style="color:#6366f1;">${t.ref}</b></p>
                        ${actions}
                    </div>
                    <div class="item-meta">
                        <div class="price-tag">${t.amount.toLocaleString()} F</div>
                        <div style="margin-top:5px;">${statusBadge}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- RENDERING USERS ---
        function renderUsers(list) {
            const container = document.getElementById('usersList');
            container.innerHTML = list.map(u => `
                <div class="item-card">
                    <div class="item-info">
                        <h4>${u.email}</h4>
                        <p>Inscrit le ${new Date(u.createdAt).toLocaleDateString()}</p>
                        <div class="actions">
                           <button class="btn-act btn-delete" onclick="deleteUser('${u._id}')"><i class="fa-solid fa-trash"></i> Supprimer</button>
                           <button class="btn-act btn-approve" onclick="addBonus('${u._id}')"><i class="fa-solid fa-gift"></i> +100 Credits</button>
                        </div>
                    </div>
                    <div class="item-meta">
                        <div style="font-size:1.2rem; font-weight:800; color:#0f172a;">${u.credits} <small style="font-size:0.8rem; color:#64748b;">cr√©dits</small></div>
                        <div style="color:#10b981; font-size:0.9rem;">${u.opens || 0} vues</div>
                    </div>
                </div>
            `).join('');
        }

        // --- RENDERING FEEDBACKS ---
        function renderFeedbacks(list) {
            const container = document.getElementById('feedbacksList');
            if(list.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px;">Aucun message.</div>'; return; }
            container.innerHTML = list.map(f => `
                <div class="item-card">
                    <div class="item-info">
                        <h4>${f.type === 'bug' ? 'üêõ Bug' : 'üí° Suggestion'} <span style="font-weight:400; color:#64748b;">par ${f.userId ? f.userId.email : 'Anonyme'}</span></h4>
                        <p style="font-size:1rem; color:#334155; margin-top:5px;">"${f.message}"</p>
                        <p style="font-size:0.8rem; margin-top:10px; color:#94a3b8;">${new Date(f.date).toLocaleDateString()}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- ACTIONS API ---
        async function processTransac(id, action) {
            if(!confirm(action === 'approve' ? "Confirmer la r√©ception de l'argent ?" : "Refuser cette demande ?")) return;
            try {
                const res = await fetch('/api/admin/validate-transaction', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ transactionId: id, action: action })
                });
                loadData(); // Recharger sans rafra√Æchir la page
            } catch(e) { alert("Erreur r√©seau"); }
        }

        async function deleteUser(id) {
            if(!confirm("‚ö†Ô∏è ATTENTION : Supprimer cet utilisateur et tout son historique ?")) return;
            await fetch('/api/admin/user/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
            loadData();
        }

        async function addBonus(id) {
            if(!confirm("Offrir 100 cr√©dits gratuits ?")) return;
            await fetch('/api/admin/credits', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ userId: id, amount: 100 })
            });
            loadData();
        }

        // Lancer au d√©marrage
        loadData();
    </script>
</body>
</html>