<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Administration</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --dark: #0f172a; --light: #f8fafc; --accent: #6366f1; }
        body { font-family: 'Inter', sans-serif; background: var(--light); margin: 0; display: flex; }
        .sidebar { width: 250px; background: var(--dark); color: white; height: 100vh; padding: 20px; position: fixed; }
        .logo { font-size: 1.2rem; font-weight: 800; margin-bottom: 40px; color: var(--accent); display: flex; align-items: center; gap: 10px; }
        .menu-item { display: block; padding: 12px; color: #94a3b8; text-decoration: none; border-radius: 8px; margin-bottom: 5px; }
        .menu-item.active { background: #1e293b; color: white; }
        .content { margin-left: 250px; padding: 40px; width: 100%; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .kpi-title { font-size: 0.8rem; color: #64748b; font-weight: 600; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--dark); margin-top: 5px; }
        .table-container { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; text-align: left; padding: 15px; font-size: 0.8rem; color: #64748b; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        
        .btn-action { border: 1px solid #e2e8f0; background: white; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-right: 5px; }
        .btn-action:hover { background: #f8fafc; border-color: #cbd5e1; }
        
        /* BOUTON SUPPRIMER ROUGE */
        .btn-danger { color: #ef4444; border-color: #fca5a5; }
        .btn-danger:hover { background: #fef2f2; border-color: #ef4444; }

        .tag-bug { background: #fee2e2; color: #b91c1c; padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }
        .tag-feat { background: #dbeafe; color: #1e40af; padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }
        .tag-other { background: #f3f4f6; color: #374151; padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-layer-group"></i> Admin Panel</div>
        <a href="#" class="menu-item active"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
        <a href="/" class="menu-item"><i class="fa-solid fa-arrow-left"></i> Retour Site</a>
    </div>

    <div class="content">
        <h1>Vue d'ensemble</h1>
        <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-title">UTILISATEURS</div><div class="kpi-value" id="kpiUsers">-</div></div>
            <div class="kpi-card"><div class="kpi-title">CRÉDITS</div><div class="kpi-value" id="kpiCredits">-</div></div>
            <div class="kpi-card"><div class="kpi-title">ENVOIS</div><div class="kpi-value" id="kpiSent">-</div></div>
            <div class="kpi-card"><div class="kpi-title">VUES</div><div class="kpi-value" id="kpiOpens">-</div></div>
        </div>

        <div class="table-container">
            <div style="padding: 20px; border-bottom: 1px solid #e2e8f0; font-weight: bold;">Utilisateurs</div>
            <table>
                <thead><tr><th>Email</th><th>Inscrit le</th><th>Crédits</th><th>Vues</th><th>Actions</th></tr></thead>
                <tbody id="usersTable"><tr><td colspan="5" style="text-align:center; padding:20px;">...</td></tr></tbody>
            </table>
        </div>

        <div class="table-container">
            <div style="padding: 20px; border-bottom: 1px solid #e2e8f0; font-weight: bold;">Retours Utilisateurs (Feedbacks)</div>
            <table>
                <thead><tr><th>Date</th><th>Utilisateur</th><th>Type</th><th>Message</th></tr></thead>
                <tbody id="feedbackTable"><tr><td colspan="4" style="text-align:center; padding:20px;">Chargement...</td></tr></tbody>
            </table>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if(!token) window.location.href = '/login';

        async function loadData() {
            try {
                // STATS
                const resStats = await fetch('/api/admin/stats', { headers: { 'Authorization': 'Bearer ' + token } });
                const stats = await resStats.json();
                document.getElementById('kpiUsers').innerText = stats.totalUsers;
                document.getElementById('kpiCredits').innerText = stats.totalCredits;
                document.getElementById('kpiSent').innerText = stats.totalSent;
                document.getElementById('kpiOpens').innerText = stats.totalOpens;

                // USERS
                const resUsers = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + token } });
                const users = await resUsers.json();
                document.getElementById('usersTable').innerHTML = users.map(u => `
                    <tr>
                        <td>${u.email}</td>
                        <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                        <td style="font-weight:bold; color:${u.credits<10?'red':'green'}">${u.credits}</td>
                        <td>${u.opens || 0}</td>
                        <td>
                            <button class="btn-action" title="+500 Crédits" onclick="addCredits('${u._id}', 500)">+500</button>
                            <button class="btn-action" title="-500 Crédits" onclick="addCredits('${u._id}', -500)">-500</button>
                            <button class="btn-action btn-danger" title="Supprimer définitivement" onclick="deleteUser('${u._id}', '${u.email}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`).join('');

                // FEEDBACKS
                const resFeed = await fetch('/api/admin/feedbacks', { headers: { 'Authorization': 'Bearer ' + token } });
                const feeds = await resFeed.json();
                document.getElementById('feedbackTable').innerHTML = feeds.length ? feeds.map(f => {
                    let badge = f.type === 'bug' ? 'tag-bug' : (f.type === 'feature' ? 'tag-feat' : 'tag-other');
                    let label = f.type === 'bug' ? 'BUG' : (f.type === 'feature' ? 'IDÉE' : 'AUTRE');
                    return `
                    <tr>
                        <td>${new Date(f.date).toLocaleDateString()}</td>
                        <td>${f.userId ? f.userId.email : 'Inconnu'}</td>
                        <td><span class="${badge}">${label}</span></td>
                        <td>${f.message}</td>
                    </tr>`;
                }).join('') : '<tr><td colspan="4" style="text-align:center; padding:20px;">Aucun feedback reçu.</td></tr>';

            } catch(e) { console.error(e); }
        }

        async function addCredits(userId, amount) {
            if(!confirm(`Confirmer l'ajout de ${amount} crédits ?`)) return;
            await fetch('/api/admin/credits', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body:JSON.stringify({userId, amount}) });
            loadData();
        }

        // --- FONCTION SUPPRESSION (NOUVEAU) ---
        async function deleteUser(userId, email) {
            if(!confirm(`⚠️ ATTENTION ⚠️\n\nVoulez-vous vraiment SUPPRIMER DÉFINITIVEMENT l'utilisateur : ${email} ?\n\nCette action est irréversible.`)) return;
            
            try {
                const res = await fetch(`/api/admin/user/${userId}`, { 
                    method: 'DELETE', 
                    headers: { 'Authorization': 'Bearer ' + token } 
                });
                const data = await res.json();
                if(data.success) {
                    alert("Utilisateur supprimé avec succès.");
                    loadData(); // Rafraîchir la liste
                } else {
                    alert("Erreur lors de la suppression.");
                }
            } catch(e) { alert("Erreur technique."); }
        }

        loadData();
    </script>
</body>
</html>