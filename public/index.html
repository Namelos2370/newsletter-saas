<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Newsletter SaaS</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        :root { --primary: #6366f1; --primary-dark: #4f46e5; --bg: #f8fafc; --text-main: #0f172a; --border: #e2e8f0; --radius: 16px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; min-height: 100vh; padding-bottom: 100px; }
        .wrapper { max-width: 1200px; margin: 0 auto; }
        
        /* HEADER RESPONSIVE */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; }
        .brand h1 { font-size: 1.4rem; font-weight: 800; margin: 0; color: var(--primary); letter-spacing: -0.5px; }
        .header-actions { display: flex; gap: 10px; }
        .action-btn { background: white; border: 1px solid var(--border); padding: 10px 16px; border-radius: 50px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 0.85rem; color: #475569; transition: 0.2s; text-decoration: none; white-space: nowrap; }
        .action-btn i { font-size: 1rem; }
        
        /* STATS */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 15px 20px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.02); display: flex; flex-direction: column; justify-content: center; }
        .stat-card h3 { margin: 0; font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .stat-card p { margin: 5px 0 0 0; font-size: 1.6rem; font-weight: 800; color: var(--text-main); }
        .btn-recharge { background: var(--text-main); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; margin-top: 10px; font-weight: 600; width: 100%; }

        /* MAIN GRID */
        .main-grid { display: grid; grid-template-columns: 1fr 1.6fr; gap: 25px; }
        .card { background: white; border-radius: var(--radius); padding: 25px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        .card h3 { margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        
        /* FORM ELEMENTS */
        input, textarea, select { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; background: #f8fafc; font-size: 0.95rem; font-family: inherit; margin-top: 8px; outline: none; transition: 0.2s; }
        input:focus, textarea:focus { border-color: var(--primary); background: white; }
        
        .upload-box { border: 2px dashed #cbd5e1; padding: 25px; text-align: center; border-radius: 12px; cursor: pointer; margin-bottom: 15px; background: #f8fafc; color: #64748b; font-weight: 500; transition: 0.2s; }
        .upload-box:active { background: #e2e8f0; }

        .btn-send { background: var(--text-main); color: white; width: 100%; padding: 18px; border-radius: 14px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 25px; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
        .btn-send:active { transform: scale(0.98); }

        /* EDITOR */
        #editor-container { height: 300px; background: white; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; font-size: 16px; }
        .ql-toolbar { border-top-left-radius: 12px; border-top-right-radius: 12px; background: #f1f5f9; border-color: var(--border)!important; }
        .ql-container { border-color: var(--border)!important; font-family: 'Plus Jakarta Sans', sans-serif; }

        /* AI BUTTON */
        .ai-group { display: flex; gap: 10px; margin-bottom: 15px; }
        #btnAi { background: linear-gradient(135deg,#8b5cf6,#6366f1); color: white; border: none; border-radius: 12px; padding: 0 20px; font-weight: 600; white-space: nowrap; cursor: pointer; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 20px; }
        .modal-box { background: white; padding: 25px; border-radius: 24px; width: 100%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .plan-card { border: 1px solid var(--border); border-radius: 12px; padding: 15px; cursor: pointer; text-align: left; font-size: 0.9rem; transition:0.2s; display:flex; flex-direction:column; justify-content:space-between; }
        .plan-card:hover { border-color: var(--primary); background: #f0fdfa; transform: translateY(-2px); }
        .plan-price { font-weight: 800; margin-top: 5px; color: var(--text-main); font-size: 1.1rem; }
        .pack-features { list-style: none; padding: 0; margin: 10px 0; font-size: 0.75rem; color: #64748b; }
        .pack-features li { display: flex; gap: 5px; margin-bottom: 3px; }
        
        .btn-whatsapp { background: #25D366; color: white; width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 700; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; text-decoration: none; font-size: 0.95rem; }
        .btn-whatsapp:hover { background: #128C7E; }

        .instruction-step { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-start; }
        .step-num { background: var(--primary); color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 0.8rem; flex-shrink: 0; }

        /* CHATBOT & WIDGETS */
        .chat-btn { position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; z-index: 5000; box-shadow: 0 4px 15px rgba(99,102,241,0.4); }
        .chat-window { position: fixed; bottom: 90px; right: 25px; width: 340px; height: 50vh; background: white; border-radius: 20px; display: none; flex-direction: column; z-index: 5000; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid var(--border); overflow: hidden; }
        
        /* MOBILE OPTIMIZATION */
        @media (max-width: 768px) {
            body { padding: 15px; padding-bottom: 90px; }
            .header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .header-actions { width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
            .action-btn { justify-content: center; padding: 12px; font-size: 0.8rem; }
            .action-btn span { display: none; } 
            .action-btn i { font-size: 1.2rem; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .stats-row .stat-card:first-child { grid-column: 1 / -1; display: flex; flex-direction: row; align-items: center; justify-content: space-between; }
            .stats-row .stat-card:first-child .btn-recharge { width: auto; margin: 0; }
            .main-grid { grid-template-columns: 1fr; gap: 20px; }
            .pricing-grid { grid-template-columns: 1fr; } 
            .chat-window { width: 90%; left: 5%; right: 5%; bottom: 90px; height: 60vh; }
        }
    </style>
</head>
<body>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';
        function logout() { localStorage.clear(); window.location.href = '/login'; }
    </script>

    <div class="wrapper">
        <div class="header">
            <div class="brand"><h1>Newsletter SaaS</h1></div>
            <div class="header-actions">
                <button class="action-btn" onclick="openFeedback()"><i class="fa-regular fa-comment-dots"></i> <span>Avis</span></button>
                <a href="/admin" id="adminBtn" class="action-btn" style="display:none; color:#ef4444; border-color:#fca5a5;"><i class="fa-solid fa-lock"></i> <span>Admin</span></a>
                <button class="action-btn" onclick="openConfig()"><i class="fa-solid fa-gear"></i> <span>Config</span></button>
                <button class="action-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i> <span>Sortir</span></button>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div>
                    <h3>Cr√©dits Dispo</h3>
                    <p id="creditsDisplay">--</p>
                </div>
                <button class="btn-recharge" onclick="openPayment()">+ Recharger</button>
            </div>
            <div class="stat-card"><h3>Vues</h3><p id="opensDisplay">--</p></div>
            <div class="stat-card"><h3>Contacts</h3><p id="countDisplay">0</p></div>
        </div>

        <div class="main-grid">
            <div class="card">
                <h3><i class="fa-solid fa-users-line" style="color:var(--primary)"></i> Audience</h3>
                <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size:1.5rem; margin-bottom:5px;"></i><br>
                    Importer (Excel/PDF)
                    <input type="file" id="fileInput" accept=".pdf,.csv,.xlsx" style="display:none;" onchange="importFile()">
                </div>
                <textarea id="emailList" style="height: 150px;" placeholder="Collez vos emails ici..."></textarea>
                <div style="font-size:0.8rem; color:#64748b; margin-top:5px; text-align:right;" id="count">0 contacts</div>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-pen-nib" style="color:var(--primary)"></i> Message</h3>
                <div class="ai-group">
                    <input type="text" id="aiTopic" placeholder="Sujet (ex: Promo -50%)" style="margin:0;">
                    <button onclick="generateAI()" id="btnAi"><i class="fa-solid fa-wand-magic-sparkles"></i> IA</button>
                </div>
                <input type="text" id="subject" placeholder="Objet du mail">
                <div id="editor-container"></div>
                
                <label style="display:flex; align-items:center; gap:10px; margin-top:15px; cursor:pointer; background:#f1f5f9; padding:10px; border-radius:10px;">
                    <i class="fa-solid fa-paperclip"></i> Ajouter une pi√®ce jointe
                    <input type="file" id="mailAttachment" style="display:none;" onchange="if(this.files[0]) alert('Fichier ajout√©: '+this.files[0].name)">
                </label>
            </div>
        </div>

        <button class="btn-send" onclick="sendMail()">
            <i class="fa-solid fa-paper-plane"></i> Envoyer la campagne
        </button>
    </div>

    <div id="paymentModal" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.3rem;">Choisir un Pack</h2>
                <i class="fa-solid fa-xmark" style="font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('paymentModal').style.display='none'"></i>
            </div>
            
            <div id="step1">
                <div class="pricing-grid">
                    <div class="plan-card" onclick="selectPack('starter', 3000)">
                        <div>
                            <b style="color:#0f172a;">STARTER</b>
                            <ul class="pack-features">
                                <li><i class="fa-solid fa-check" style="color:green;"></i> 500 Cr√©dits</li>
                                <li><i class="fa-solid fa-check" style="color:green;"></i> IA Basic</li>
                                <li><i class="fa-solid fa-check" style="color:green;"></i> Support Standard</li>
                            </ul>
                        </div>
                        <span class="plan-price">3 000 FCFA</span>
                    </div>
                    <div class="plan-card" style="border-color:var(--primary); background:#eef2ff;" onclick="selectPack('pro', 10000)">
                        <div>
                            <b style="color:var(--primary);">PRO</b>
                            <ul class="pack-features">
                                <li><i class="fa-solid fa-check" style="color:green;"></i> 2 000 Cr√©dits</li>
                                <li><i class="fa-solid fa-check" style="color:green;"></i> IA Avanc√©e</li>
                                <li><i class="fa-solid fa-check" style="color:green;"></i> Priorit√© d'envoi</li>
                            </ul>
                        </div>
                        <span class="plan-price">10 000 FCFA</span>
                    </div>
                    <div class="plan-card" onclick="selectPack('business', 20000)">
                        <div>
                            <b style="color:#0f172a;">BUSINESS</b>
                            <ul class="pack-features">
                                <li><i class="fa-solid fa-check" style="color:green;"></i> 5 000 Cr√©dits</li>
                                <li><i class="fa-solid fa-check" style="color:green;"></i> Support VIP</li>
                                <li><i class="fa-solid fa-check" style="color:green;"></i> Tracking Pro</li>
                            </ul>
                        </div>
                        <span class="plan-price">20 000 FCFA</span>
                    </div>
                </div>
            </div>

            <div id="step2" style="display:none;">
                <h3 style="margin:0 0 15px 0; color:var(--primary); text-align:center;">Finaliser le Paiement</h3>
                
                <div class="instruction-step">
                    <div class="step-num">1</div>
                    <div style="font-size:0.9rem;">
                        Envoyez <b><span id="amountToPay"></span> FCFA</b> par Mobile Money :
                        <div style="margin-top:5px; font-weight:bold;">
                            üü† Orange: 658 98 00 51<br>
                            üü° MTN: 653 76 33 93
                        </div>
                        <div style="font-size:0.8rem; color:#666;">(Nom: Gabriel Ezekiel Junior Fokou)</div>
                    </div>
                </div>

                <div class="instruction-step">
                    <div class="step-num">2</div>
                    <div style="width:100%;">
                        <label style="font-size:0.9rem; font-weight:600;">Saisissez l'ID de Transaction ou votre Num√©ro :</label>
                        <input type="tel" id="payRef" placeholder="Ex: 699 99..." style="font-size:1rem; padding:12px;">
                    </div>
                </div>

                <div class="instruction-step">
                    <div class="step-num">3</div>
                    <div style="font-size:0.9rem;">Cliquez sur valider. Vos cr√©dits seront ajout√©s apr√®s v√©rification (max 10 min).</div>
                </div>

                <button onclick="sendPaymentRequest()" class="btn-send" style="margin-top:10px;">Valider le paiement</button>

                <a href="https://wa.me/237658980051" target="_blank" class="btn-whatsapp">
                    <i class="fa-brands fa-whatsapp" style="font-size:1.2rem;"></i> Un probl√®me ? Contactez-nous
                </a>

                <div style="text-align:center; margin-top:15px; text-decoration:underline; cursor:pointer; color:#64748b;" onclick="resetPay()">Retour au choix</div>
            </div>
        </div>
    </div>

    <div class="chat-btn" onclick="toggleChat()"><i class="fa-solid fa-robot"></i></div>
    <div class="chat-window" id="chatWindow">
        <div style="background:var(--primary); color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between;">
            <span>Assistant</span> <i class="fa-solid fa-xmark" onclick="toggleChat()"></i>
        </div>
        <div class="chat-body" id="chatBody"><div style="background:white; border:1px solid #e2e8f0; padding:8px 12px; border-radius:12px; display:inline-block; font-size:0.9rem;">Bonjour ! Comment puis-je vous aider ?</div></div>
        <div class="chat-footer">
            <input type="text" id="chatInput" placeholder="√âcrivez ici..." style="margin:0; border-radius:20px;">
            <button onclick="sendChat()" style="background:var(--primary); color:white; border:none; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="configModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Configuration Gmail</h3>
            <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">Utilisez votre propre adresse d'envoi (Optionnel).</p>
            <input type="email" id="smtpUser" placeholder="votre@gmail.com">
            <input type="password" id="smtpPass" placeholder="Mot de passe d'application">
            <button onclick="saveConfig()" class="btn-send">Enregistrer</button>
            <div style="text-align:center; margin-top:15px; text-decoration:underline; cursor:pointer;" onclick="document.getElementById('configModal').style.display='none'">Fermer</div>
        </div>
    </div>

    <div id="feedbackModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Votre avis</h3>
            <select id="feedType"><option value="suggestion">üí° Suggestion</option><option value="bug">üêõ Bug</option></select>
            <textarea id="feedMsg" placeholder="Votre message..." style="height:100px;"></textarea>
            <button onclick="sendFeedback()" class="btn-send">Envoyer</button>
            <div style="text-align:center; margin-top:15px; text-decoration:underline; cursor:pointer;" onclick="document.getElementById('feedbackModal').style.display='none'">Fermer</div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        var quill = new Quill('#editor-container', { theme: 'snow', modules: { toolbar: [['bold', 'italic'], [{ 'list': 'bullet' }], ['link']] } }); // Toolbar simplifi√©e Mobile
        
        // INIT
        if(localStorage.getItem('isAdmin')==='true') document.getElementById('adminBtn').style.display='flex';
        document.getElementById('creditsDisplay').innerText = localStorage.getItem('credits') || "--";
        document.getElementById('opensDisplay').innerText = localStorage.getItem('opens') || "0";
        
        // AUTO SAVE & COUNT
        const emailList = document.getElementById('emailList');
        emailList.addEventListener('input', (e) => { localStorage.setItem('d_list', e.target.value); updateCount(); });
        if(localStorage.getItem('d_list')) { emailList.value = localStorage.getItem('d_list'); updateCount(); }

        function updateCount() {
            const count = emailList.value.split('\n').filter(l=>l.includes('@')).length;
            document.getElementById('count').innerText = count + " contacts";
            document.getElementById('countDisplay').innerText = count;
        }

        // PAIEMENT
        let currentPack = '';
        function openPayment() { document.getElementById('paymentModal').style.display='flex'; resetPay(); }
        function selectPack(pack, price) {
            currentPack = pack;
            document.getElementById('step1').style.display='none';
            document.getElementById('step2').style.display='block';
            document.getElementById('amountToPay').innerText = price.toLocaleString();
        }
        function resetPay() { document.getElementById('step1').style.display='block'; document.getElementById('step2').style.display='none'; }
        
        async function sendPaymentRequest() {
            const ref = document.getElementById('payRef').value;
            if(!ref) return alert("Num√©ro manquant");
            try {
                await fetch('/api/payment/declare', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body:JSON.stringify({ pack: currentPack, ref }) });
                alert("‚úÖ Envoy√© ! Validation en cours."); document.getElementById('paymentModal').style.display='none';
            } catch(e) { alert("Erreur connexion"); }
        }

        // CORE FUNCTIONS
        async function importFile() {
            const fi = document.getElementById('fileInput');
            if(!fi.files.length) return;
            const fd = new FormData(); fd.append('file', fi.files[0]);
            try {
                const res = await fetch('/extract-file', { method:'POST', headers:{'Authorization':'Bearer '+token}, body:fd });
                const data = await res.json();
                emailList.value += (emailList.value?'\n':'') + data.contacts.join('\n');
                updateCount();
            } catch(e){ alert("Erreur import"); }
        }

        async function generateAI() {
            const btn = document.getElementById('btnAi'); 
            const originalText = btn.innerHTML;
            btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i>";
            try {
                const res = await fetch('/generate-content', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body:JSON.stringify({topic:document.getElementById('aiTopic').value}) });
                const data = await res.json();
                document.getElementById('subject').value = data.subject;
                quill.root.innerHTML = data.body;
            } catch(e){ alert("Erreur IA"); }
            btn.innerHTML = originalText;
        }

        async function sendMail() {
            const list = emailList.value.split('\n').filter(l=>l.includes('@')).map(l=>{const p=l.split(','); return {email:p[0].trim(), name:p[1]||''}});
            if(!list.length) return alert("Ajoutez des contacts !");
            
            const btn = document.querySelector('.btn-send');
            const originalText = btn.innerHTML;
            btn.innerHTML = "<i class='fa-solid fa-circle-notch fa-spin'></i> Envoi...";
            btn.disabled = true;

            const fd = new FormData();
            fd.append('recipients', JSON.stringify(list));
            fd.append('subject', document.getElementById('subject').value);
            fd.append('message', quill.root.innerHTML);
            if(document.getElementById('mailAttachment').files[0]) fd.append('attachment', document.getElementById('mailAttachment').files[0]);

            try {
                const res = await fetch('/send-mail', { method:'POST', headers:{'Authorization':'Bearer '+token}, body:fd });
                const data = await res.json();
                if(data.success) {
                    alert(`‚úÖ ${data.count} Mails envoy√©s !`);
                    localStorage.setItem('credits', data.newCredits);
                    document.getElementById('creditsDisplay').innerText = data.newCredits;
                } else { alert("Erreur: " + data.error); }
            } catch(e) { alert("Erreur technique"); }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        // CHAT & MODALS
        function toggleChat() { const w=document.getElementById('chatWindow'); w.style.display = w.style.display==='flex'?'none':'flex'; }
        async function sendChat() {
            const i = document.getElementById('chatInput');
            const txt = i.value; if(!txt) return;
            const b = document.getElementById('chatBody');
            b.innerHTML += `<div style="text-align:right; margin:8px 0;"><span style="background:var(--primary); color:white; padding:8px 12px; border-radius:12px; display:inline-block;">${txt}</span></div>`;
            i.value='';
            const res = await fetch('/api/assist', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body:JSON.stringify({question:txt}) });
            const data = await res.json();
            b.innerHTML += `<div style="margin:8px 0;"><span style="background:white; border:1px solid #e2e8f0; padding:8px 12px; border-radius:12px; display:inline-block; font-size:0.9rem;">${data.reply}</span></div>`;
            b.scrollTop = b.scrollHeight;
        }

        function openFeedback() { document.getElementById('feedbackModal').style.display='flex'; }
        async function sendFeedback() {
             await fetch('/api/feedback', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body:JSON.stringify({type:document.getElementById('feedType').value, message:document.getElementById('feedMsg').value}) });
             alert("Merci !"); document.getElementById('feedbackModal').style.display='none';
        }
        function openConfig() { document.getElementById('configModal').style.display='flex'; }
        async function saveConfig() {
            await fetch('/api/settings/smtp', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body:JSON.stringify({smtpUser:document.getElementById('smtpUser').value, smtpPass:document.getElementById('smtpPass').value}) });
            alert("Sauvegard√©"); document.getElementById('configModal').style.display='none';
        }
    </script>
</body>
</html>