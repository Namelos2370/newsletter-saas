<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Newsletter SaaS - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --primary: #6366f1; --primary-dark: #4f46e5; --bg: #f1f5f9; --text-main: #0f172a; --border: #e2e8f0; --radius: 16px; --success: #10b981; --whatsapp: #25D366; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; min-height: 100vh; padding-bottom: 100px; }
        .wrapper { max-width: 1200px; margin: 0 auto; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; position: relative; z-index: 100; }
        .brand h1 { font-size: 1.4rem; font-weight: 800; margin: 0; color: var(--primary); letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; gap: 10px; }
        .action-btn { background: white; border: 1px solid var(--border); padding: 10px 16px; border-radius: 50px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 0.85rem; color: #475569; transition: all 0.2s ease; text-decoration: none; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .action-btn:hover { transform: translateY(-2px); border-color: var(--primary); color: var(--primary); box-shadow: 0 5px 12px rgba(99,102,241,0.2); }
        
        /* STATS */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; position: relative; z-index: 1; }
        .stat-card { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); position: relative; overflow: hidden; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: var(--primary); }
        .stat-card h3 { margin: 0; font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .stat-card p { margin: 10px 0 0 0; font-size: 1.8rem; font-weight: 800; color: var(--text-main); }
        .btn-recharge { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 50px; font-size: 0.8rem; cursor: pointer; margin-top: 15px; font-weight: 700; width: 100%; transition: 0.2s; box-shadow: 0 4px 10px rgba(99,102,241,0.3); }

        /* MAIN GRID */
        .main-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px; margin-bottom: 25px; }
        .card { background: white; border-radius: var(--radius); padding: 25px; border: 1px solid var(--border); transition: all 0.3s ease; }
        .card h3 { margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; color: var(--text-main); font-weight: 700; }
        
        /* INPUTS & TOOLS */
        input, textarea, select { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; background: #f8fafc; font-size: 0.95rem; font-family: inherit; margin-top: 8px; outline: none; transition: 0.2s; }
        input:focus, textarea:focus { border-color: var(--primary); background: white; }
        .upload-box { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 16px; cursor: pointer; margin-bottom: 15px; background: #f8fafc; color: #64748b; font-weight: 600; transition: all 0.2s; }
        .upload-box:hover { border-color: var(--primary); background: #eef2ff; color: var(--primary); }
        .tools-row { display: flex; gap: 10px; margin-top: 10px; }
        .tool-btn { flex: 1; padding: 10px; border: 1px solid var(--border); background: white; border-radius: 10px; cursor: pointer; font-size: 0.8rem; font-weight: 600; color: #475569; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .tool-btn:hover { background: #f8fafc; border-color: var(--text-main); color: var(--text-main); }
        #qrResult { margin-top: 15px; display: none; text-align: center; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px dashed #cbd5e1; }
        #qrcode { display: inline-block; margin: 10px 0; }

        /* EDITOR AREAS */
        .attachment-area { display:flex; align-items:center; gap:10px; margin-top:15px; background:#f1f5f9; padding:10px 15px; border-radius:12px; border: 1px solid var(--border); }
        .file-chip { display:none; align-items:center; gap:10px; background:white; padding:5px 10px; border-radius:50px; font-size:0.85rem; border:1px solid var(--primary); color:var(--primary); font-weight:600; }
        .wa-tool { background: #dcfce7; border: 1px solid #86efac; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
        .wa-row { display: flex; gap: 10px; align-items: center; }
        .btn-add-wa { background: var(--whatsapp); color: white; border: none; padding: 0 20px; border-radius: 10px; font-weight: 700; cursor: pointer; height: 48px; white-space: nowrap; }
        .btn-send { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 800; font-size: 1.1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 10px 25px -5px rgba(99,102,241,0.5); transition: 0.2s; }
        .btn-send:hover { transform: translateY(-3px); }
        
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); transition: 0.2s; }
        .badge { padding: 5px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; background: #eef2ff; color: var(--primary); }
        #editor-container { height: 300px; background: white; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; font-size: 16px; border: 2px solid var(--border); border-top: none; }
        .ql-toolbar { border-top-left-radius: 12px; border-top-right-radius: 12px; background: #f8fafc; border: 2px solid var(--border)!important; }
        .ql-container { border: none!important; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .ai-group { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        #btnAi { background: linear-gradient(135deg,#8b5cf6,#6366f1); color: white; border: none; border-radius: 12px; padding: 0 20px; font-weight: 700; white-space: nowrap; cursor: pointer; height: 50px; }
        .mic-active { color: red !important; animation: beat 1s infinite; }
        @keyframes beat { 0% { transform: translateY(-50%) scale(1); } 50% { transform: translateY(-50%) scale(1.2); } 100% { transform: translateY(-50%) scale(1); } }

        /* --- MODALS (AMELIOREES) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); padding: 20px; }
        .modal-box { background: white; padding: 30px; border-radius: 24px; width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        
        /* PRICING STYLES */
        .pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .plan-card { border: 2px solid var(--border); border-radius: 16px; padding: 15px; cursor: pointer; text-align: center; transition: 0.2s; background: #fff; display: flex; flex-direction: column; justify-content: space-between; }
        .plan-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 10px 20px rgba(99,102,241,0.1); }
        .plan-title { font-weight: 800; font-size: 1rem; color: #64748b; margin-bottom: 5px; display: block; }
        .plan-price { font-weight: 900; font-size: 1.1rem; color: var(--text-main); display: block; margin-bottom: 10px; }
        .plan-features { list-style: none; padding: 0; margin: 0; text-align: left; font-size: 0.75rem; color: #475569; }
        .plan-features li { margin-bottom: 5px; display: flex; gap: 5px; align-items: center; }
        .plan-features li i { color: var(--success); }

        /* STEP STYLES */
        .pay-step { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .pay-step h4 { margin: 0 0 10px 0; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; }
        .step-num { background: var(--text-main); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        
        /* CHATBOT */
        .chat-btn { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; z-index: 5000; }
        .chat-window { position: fixed; bottom: 100px; right: 25px; width: 360px; height: 55vh; background: white; border-radius: 24px; display: none; flex-direction: column; z-index: 5000; border: 1px solid var(--border); overflow: hidden; }
        .typing { display: inline-flex; gap: 5px; background: white; padding: 12px 16px; border-radius: 16px; border-bottom-left-radius: 4px; border: 1px solid #e2e8f0; margin: 10px 0; width: fit-content; }
        .dot { width: 8px; height: 8px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        @media (max-width: 900px) {
            body { padding: 15px; padding-bottom: 90px; }
            .header { flex-direction: column; align-items: flex-start; }
            .header-actions { width: 100%; display: grid; grid-template-columns: repeat(4, 1fr); }
            .action-btn span { display: none; }
            .stats-row { grid-template-columns: 1fr; }
            .main-grid { grid-template-columns: 1fr; }
            .pricing-grid { grid-template-columns: 1fr; } 
        }
    </style>
</head>
<body>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';
    </script>

    <div class="wrapper">
        <div class="header">
            <div class="brand"><h1><i class="fa-solid fa-paper-plane"></i> Newsletter SaaS</h1></div>
            <div class="header-actions">
                <button class="action-btn" onclick="openFeedback()"><i class="fa-regular fa-comment-dots"></i> <span>Avis</span></button>
                <a href="/admin" id="adminBtn" class="action-btn" style="display:none; color:#ef4444; border-color:#fca5a5;"><i class="fa-solid fa-lock"></i> <span>Admin</span></a>
                <button class="action-btn" onclick="openConfig()"><i class="fa-solid fa-gear"></i> <span>Config</span></button>
                <button class="action-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i> <span>Sortir</span></button>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-card" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
                <div><h3 style="color:rgba(255,255,255,0.8);">Cr√©dits</h3><p style="color:white;" id="creditsDisplay">--</p></div>
                <button class="btn-recharge" style="background:white; color:var(--primary);" onclick="openPayment()">+ Recharger</button>
            </div>
            <div class="stat-card"><h3>Vues Totales</h3><p id="opensDisplay">--</p></div>
            <div class="stat-card"><h3>Contacts</h3><p id="countDisplay">0</p></div>
        </div>

        <div class="main-grid">
            <div style="display:flex; flex-direction:column; gap:25px;">
                <div class="card">
                    <h3><i class="fa-solid fa-users-line" style="color:var(--primary)"></i> Audience</h3>
                    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Importer Fichier
                        <input type="file" id="fileInput" accept=".csv,.xlsx" style="display:none;" onchange="importFile(this.files[0])">
                    </div>
                    <textarea id="emailList" style="height: 180px; font-family:monospace;" placeholder="Ex: client1@mail.com"></textarea>
                    <div class="tools-row">
                        <button class="tool-btn" onclick="cleanList()"><i class="fa-solid fa-broom"></i> Nettoyer</button>
                        <div style="font-size:0.9rem; color:#64748b; font-weight:600; padding:10px;" id="count">0 contacts</div>
                    </div>
                </div>
                <div class="card">
                    <h3><i class="fa-solid fa-toolbox" style="color:#f59e0b;"></i> Outils Boutique</h3>
                    <p style="font-size:0.85rem; color:#64748b; margin-top:5px;">QR Code pour inscription WhatsApp.</p>
                    <input type="text" id="qrNumber" placeholder="Num√©ro WhatsApp (ex: 237...)" style="margin-top:10px;">
                    <button class="btn-recharge" onclick="generateQR()" style="margin-top:10px; background:#0f172a; border-radius:10px;">G√©n√©rer QR Code</button>
                    <div id="qrResult"><div id="qrcode"></div><p style="font-size:0.8rem; font-weight:bold; margin-top:10px;">√Ä imprimer !</p></div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-pen-nib" style="color:var(--primary)"></i> Contenu du Mail</h3>
                <div class="ai-group">
                    <div style="position:relative; width:100%;">
                        <input type="text" id="aiTopic" placeholder="D√©crivez votre offre (ex: Promo Ramadan -30%)" style="margin:0; padding-right:40px; height: 50px;">
                        <i class="fa-solid fa-microphone" id="micBtn" onclick="startDictation()" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--primary); cursor:pointer; font-size:1.2rem; transition:0.2s;" title="Dicter"></i>
                    </div>
                    <button onclick="generateAI()" id="btnAi"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                </div>
                <div class="wa-tool">
                    <div style="font-size:0.85rem; color:#166534; font-weight:700;"><i class="fa-brands fa-whatsapp"></i> Bouton WhatsApp</div>
                    <div class="wa-row">
                        <input type="tel" id="waNumber" placeholder="Num√©ro (237...)" style="margin:0; border:1px solid #86efac;">
                        <button class="btn-add-wa" onclick="insertWaBtn()">Ajouter</button>
                    </div>
                </div>
                <input type="text" id="subject" placeholder="Objet du mail...">
                <div id="editor-container"></div>
                <div class="attachment-area">
                    <label style="cursor:pointer; display:flex; align-items:center; gap:10px; font-weight:600; color:#475569;">
                        <i class="fa-solid fa-paperclip"></i> Joindre un fichier
                        <input type="file" id="mailAttachment" style="display:none;">
                    </label>
                    <div id="fileChip" class="file-chip"><span id="fileName">...</span> <i class="fa-solid fa-xmark remove-file" onclick="removeAttachment()"></i></div>
                </div>
                <button class="btn-send" onclick="sendMail()" style="margin-top:20px;"><i class="fa-solid fa-paper-plane"></i> Lancer la Campagne</button>
            </div>
        </div>

        <div class="card" style="margin-top:30px;">
             <h3><i class="fa-solid fa-clock-rotate-left" style="color:var(--primary);"></i> Derniers Envois</h3>
             <ul class="history-list" id="historyContainer"><li style="padding:20px; text-align:center; color:#64748b;">Chargement...</li></ul>
        </div>
    </div>

    <div id="paymentModal" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">Choisir un Pack</h2>
                <i class="fa-solid fa-xmark" style="font-size:1.5rem; cursor:pointer; color:#94a3b8;" onclick="document.getElementById('paymentModal').style.display='none'"></i>
            </div>
            
            <div id="step1">
                <div class="pricing-grid">
                    <div class="plan-card" onclick="selectPack('starter', 3000)">
                        <span class="plan-title">STARTER</span>
                        <span class="plan-price">3 000 FCFA</span>
                        <ul class="plan-features">
                            <li><i class="fa-solid fa-check"></i> <b>500</b> Cr√©dits</li>
                            <li><i class="fa-solid fa-check"></i> Acc√®s Dashboard</li>
                            <li><i class="fa-solid fa-check"></i> Support Standard</li>
                        </ul>
                    </div>
                    <div class="plan-card" style="border-color:var(--primary); background:#f5f3ff;" onclick="selectPack('pro', 10000)">
                        <div style="position:absolute; top:0; right:0; background:var(--primary); color:white; font-size:0.6rem; padding:2px 8px; border-bottom-left-radius:8px;">POPULAIRE</div>
                        <span class="plan-title" style="color:var(--primary);">PRO</span>
                        <span class="plan-price" style="color:var(--primary);">10 000 FCFA</span>
                        <ul class="plan-features">
                            <li><i class="fa-solid fa-check"></i> <b>2 000</b> Cr√©dits</li>
                            <li><i class="fa-solid fa-check"></i> IA R√©daction</li>
                            <li><i class="fa-solid fa-check"></i> <b>Logo Perso</b></li>
                        </ul>
                    </div>
                    <div class="plan-card" onclick="selectPack('business', 20000)">
                        <span class="plan-title">BUSINESS</span>
                        <span class="plan-price">20 000 FCFA</span>
                        <ul class="plan-features">
                            <li><i class="fa-solid fa-check"></i> <b>5 000</b> Cr√©dits</li>
                            <li><i class="fa-solid fa-check"></i> Campagnes Illimit√©es</li>
                            <li><i class="fa-solid fa-check"></i> <b>Support VIP</b></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="step2" style="display:none;">
                <h3 style="color:var(--primary); margin-bottom:20px;">Instructions de Paiement</h3>
                
                <div class="pay-step">
                    <h4><span class="step-num">1</span> Transf√©rez l'argent</h4>
                    <p style="margin:5px 0;">Envoyez <b id="amountToPay" style="font-size:1.1rem;"></b> FCFA au num√©ro :</p>
                    <p style="margin:5px 0; font-weight:700;">üü† Orange Money : 658 98 00 51</p>
                    <p style="margin:5px 0; font-weight:700;">üü° MTN MoMo : 653 76 33 93</p>
                    <small style="color:#64748b;">Nom : Gabriel Ezekiel Junior Fokou</small>
                </div>

                <div class="pay-step">
                    <h4><span class="step-num">2</span> Validation Technique</h4>
                    <p style="margin:5px 0 10px 0; font-size:0.9rem;">Entrez l'ID de transaction re√ßu par SMS :</p>
                    <input type="text" id="payRef" placeholder="Ex: PP230112..." style="border:1px solid #cbd5e1; margin-bottom:10px;">
                    <button onclick="sendPaymentRequest()" class="btn-recharge" style="width:100%;">Valider ma demande</button>
                </div>

                <div class="pay-step" style="background:#dcfce7; border-color:#86efac;">
                    <h4 style="color:#166534;"><span class="step-num" style="background:#166534;">3</span> Activation Imm√©diate</h4>
                    <p style="margin:5px 0 10px 0; font-size:0.9rem; color:#14532d;">
                        Pour activer votre compte rapidement, envoyez <b>la capture d'√©cran</b> + <b>votre email</b> sur WhatsApp.
                    </p>
                    <a href="https://wa.me/237658980051" target="_blank" style="background:#25D366; color:white; text-decoration:none; padding:10px; border-radius:8px; display:flex; align-items:center; justify-content:center; gap:8px; font-weight:bold;">
                        <i class="fa-brands fa-whatsapp"></i> Envoyer la preuve
                    </a>
                </div>

                <div style="text-align:center; margin-top:10px; text-decoration:underline; cursor:pointer; color:#64748b;" onclick="resetPay()">‚Üê Changer de pack</div>
            </div>
        </div>
    </div>

    <div class="chat-btn" onclick="toggleChat()"><i class="fa-solid fa-robot"></i></div>
    <div class="chat-window" id="chatWindow">
        <div style="background:var(--primary); color:white; padding:15px;"><b>Assistant IA</b> <i class="fa-solid fa-xmark" style="float:right; cursor:pointer;" onclick="toggleChat()"></i></div>
        <div class="chat-body" id="chatBody" style="flex:1; padding:15px; overflow-y:auto; background:#f8fafc;"></div>
        <div class="chat-footer" style="padding:10px; display:flex; gap:5px;">
            <input type="text" id="chatInput" placeholder="..." style="border-radius:20px;">
            <button onclick="sendChat()" style="background:var(--primary); color:white; border:none; width:40px; border-radius:50%;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>
    
    <div id="configModal" class="modal-overlay"> <div class="modal-box"> <h3>SMTP Perso</h3> <input type="text" id="smtpUser" placeholder="Email"> <input type="password" id="smtpPass" placeholder="Mdp App"> <button onclick="saveConfig()" class="btn-send">Sauvegarder</button> <div onclick="document.getElementById('configModal').style.display='none'" style="text-align:center; margin-top:10px; cursor:pointer;">Fermer</div> </div> </div>
    <div id="feedbackModal" class="modal-overlay"> <div class="modal-box"> <h3>Avis</h3> <select id="feedType"><option value="suggestion">Suggestion</option><option value="bug">Bug</option></select> <textarea id="feedMsg"></textarea> <button onclick="sendFeedback()" class="btn-send">Envoyer</button> <div onclick="document.getElementById('feedbackModal').style.display='none'" style="text-align:center; margin-top:10px; cursor:pointer;">Fermer</div> </div> </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';

        const emailList = document.getElementById('emailList');
        const fileInput = document.getElementById('mailAttachment');
        var quill = new Quill('#editor-container', { theme: 'snow', modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'bullet' }], ['link']] } });
        let currentPack=''; 

        if(localStorage.getItem('isAdmin')==='true') document.getElementById('adminBtn').style.display='flex';
        document.getElementById('creditsDisplay').innerText = localStorage.getItem('credits') || "--";
        document.getElementById('opensDisplay').innerText = localStorage.getItem('opens') || "0";
        if(localStorage.getItem('d_list')) { emailList.value = localStorage.getItem('d_list'); updateCount(); }
        loadHistory();

        emailList.addEventListener('input', (e) => { localStorage.setItem('d_list', e.target.value); updateCount(); });
        fileInput.addEventListener('change', function(e) { if(this.files[0]) { document.getElementById('fileName').innerText = this.files[0].name.substring(0,15); document.getElementById('fileChip').style.display = 'inline-flex'; } });
        
        function logout() { if(confirm("Voulez-vous vraiment vous d√©connecter ?")) { localStorage.clear(); window.location.href = '/login'; } }
        function updateCount() { const c = emailList.value.split('\n').filter(l=>l.includes('@')).length; document.getElementById('count').innerText = c + " contacts"; document.getElementById('countDisplay').innerText = c; }
        function removeAttachment() { fileInput.value = ''; document.getElementById('fileChip').style.display = 'none'; }
        
        async function importFile(file) { 
            if(!file) return; 
            const fd = new FormData(); fd.append('file', file); 
            try { 
                const res = await fetch('/extract-file', { method:'POST', headers:{'Authorization':'Bearer '+token}, body:fd }); 
                const data = await res.json(); 
                emailList.value += (emailList.value?'\n':'') + data.contacts.join('\n'); 
                updateCount(); 
                localStorage.setItem('d_list', emailList.value); 
            } catch(e){} 
        }

        function cleanList() { const raw = emailList.value.split('\n'); const clean = [...new Set(raw.map(e => e.trim()).filter(e => e.includes('@')))]; emailList.value = clean.join('\n'); updateCount(); localStorage.setItem('d_list', emailList.value); alert(`Nettoy√© : ${raw.length - clean.length} erreurs retir√©es.`); }
        function generateQR() { const num = document.getElementById('qrNumber').value.replace(/\s+/g, ''); if(!num) return alert("Num√©ro?"); document.getElementById('qrResult').style.display = 'block'; document.getElementById('qrcode').innerHTML = ''; new QRCode(document.getElementById("qrcode"), { text: `https://wa.me/${num}?text=Bonjour,%20je%20veux%20m'inscrire`, width: 128, height: 128 }); }
        function startDictation() { if (window.hasOwnProperty('webkitSpeechRecognition')) { const mic = document.getElementById('micBtn'); const r = new webkitSpeechRecognition(); r.continuous = false; r.lang = "fr-FR"; r.onstart = function() { mic.classList.add('mic-active'); }; r.onend = function() { mic.classList.remove('mic-active'); }; r.onresult = function(e) { document.getElementById('aiTopic').value = e.results[0][0].transcript; }; r.start(); } else { alert("Utilisez Chrome"); } }
        function insertWaBtn() { const num = document.getElementById('waNumber').value.replace(/\s+/g, ''); if(!num) return alert("Num√©ro?"); const link = `https://wa.me/${num}?text=Bonjour,%20int√©ress√©`; const html = `<br><div style="text-align:center; margin:20px 0;"><a href="${link}" style="background-color:#25D366; color:white; padding:12px 25px; text-decoration:none; border-radius:50px; font-weight:bold; font-size:16px;">Commander sur WhatsApp üí¨</a></div><br>`; const r = quill.getSelection(true); quill.clipboard.dangerouslyPasteHTML(r ? r.index : quill.getLength(), html); }

        async function generateAI() { const t=document.getElementById('aiTopic').value; if(!t) return alert("Sujet?"); const b=document.getElementById('btnAi'); b.innerHTML="..."; try{ const res=await fetch('/generate-content',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({topic:t})}); const d=await res.json(); document.getElementById('subject').value=d.subject; quill.root.innerHTML=d.body; }catch(e){} b.innerHTML=`<i class="fa-solid fa-wand-magic-sparkles"></i>`; }
        
        async function sendMail() {
            const list = emailList.value.split('\n').filter(l=>l.includes('@')).map(l=>{const p=l.split(','); return {email:p[0].trim(), name:p[1]||''}});
            if(!list.length) return alert("Contacts?");
            const btn = document.querySelector('.btn-send'); btn.innerHTML = "Envoi..."; btn.disabled = true;
            const fd = new FormData(); fd.append('recipients', JSON.stringify(list)); fd.append('subject', document.getElementById('subject').value); fd.append('message', quill.root.innerHTML);
            if(fileInput.files[0]) fd.append('attachment', fileInput.files[0]);
            try { const res = await fetch('/send-mail', { method:'POST', headers:{'Authorization':'Bearer '+token}, body:fd }); const d = await res.json(); if(d.success) { alert(`Succ√®s: ${d.count}`); localStorage.setItem('credits', d.newCredits); document.getElementById('creditsDisplay').innerText = d.newCredits; loadHistory(); localStorage.removeItem('mailDraft'); } else { alert(d.error); } } catch(e){}
            btn.innerHTML = `<i class="fa-solid fa-paper-plane"></i> Lancer la Campagne`; btn.disabled = false;
        }

        async function loadHistory() { try{ const r=await fetch('/api/history',{headers:{'Authorization':'Bearer '+token}}); const d=await r.json(); document.getElementById('historyContainer').innerHTML = d.campaigns.map(c=>`<li class="history-item"><div><b>${c.subject.substring(0,20)}</b><br><small>${new Date(c.sentAt).toLocaleDateString()}</small></div> <span class="badge">${c.recipientCount} env.</span></li>`).join(''); }catch(e){} }
        
        function openPayment(){document.getElementById('paymentModal').style.display='flex';resetPay();} 
        function selectPack(p,c){currentPack=p;document.getElementById('step1').style.display='none';document.getElementById('step2').style.display='block';document.getElementById('amountToPay').innerText=c.toLocaleString();} 
        function resetPay(){document.getElementById('step1').style.display='block';document.getElementById('step2').style.display='none';}
        
        async function sendPaymentRequest(){ const r=document.getElementById('payRef').value; if(!r) return alert("Entrez la r√©f√©rence de la transaction."); try{ await fetch('/api/payment/declare',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({pack:currentPack,ref:r})}); alert("Demande envoy√©e ! Passez √† l'√©tape 3."); }catch(e){ alert("Erreur connexion"); } }
        
        function toggleChat(){const w=document.getElementById('chatWindow'); w.style.display=w.style.display==='flex'?'none':'flex';}
        async function sendChat(){
            const i=document.getElementById('chatInput'); const t=i.value; if(!t)return; const b=document.getElementById('chatBody'); b.innerHTML+=`<div style="text-align:right;margin:5px;"><b>${t}</b></div>`; i.value=''; 
            const typingId = 'typing-' + Date.now(); b.innerHTML += `<div id="${typingId}" class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`; b.scrollTop = b.scrollHeight;
            try { const r=await fetch('/api/assist',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({question:t})}); const d=await r.json(); document.getElementById(typingId).remove(); b.innerHTML+=`<div style="margin:5px;">${d.reply}</div>`; } catch(e) { document.getElementById(typingId).remove(); } b.scrollTop = b.scrollHeight;
        }

        function openFeedback(){document.getElementById('feedbackModal').style.display='flex';} 
        async function sendFeedback(){await fetch('/api/feedback',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({type:document.getElementById('feedType').value,message:document.getElementById('feedMsg').value})}); alert("Merci"); document.getElementById('feedbackModal').style.display='none';}
        function openConfig(){document.getElementById('configModal').style.display='flex';} 
        async function saveConfig(){await fetch('/api/settings/smtp',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({smtpUser:document.getElementById('smtpUser').value,smtpPass:document.getElementById('smtpPass').value})}); alert("OK"); document.getElementById('configModal').style.display='none';}

        setInterval(() => { const draft = { sub: document.getElementById('subject').value, body: quill.root.innerHTML }; if(draft.sub || draft.body.length > 20) localStorage.setItem('mailDraft', JSON.stringify(draft)); }, 3000);
        window.addEventListener('load', () => { const s = localStorage.getItem('mailDraft'); if(s) { const d = JSON.parse(s); if(!document.getElementById('subject').value) document.getElementById('subject').value = d.sub; if(quill.root.innerHTML === '<p><br></p>') quill.root.innerHTML = d.body; } });
    </script>
</body>
</html>